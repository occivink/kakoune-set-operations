try %{
    require-module set-operations
} catch %{
    source set-operations.kak
    require-module set-operations
}

define-command assert-command-fails -params 1 %{
    eval -save-regs e %{
        reg e ''
        try %{
            eval %arg{1}
            reg e 'fail "TODO, but should have"'
        }
        eval %reg{e}
    }
}

define-command assert-selections-are -params 1 %{
    eval %sh{
        if [ "$1" != "$kak_quoted_selections" ]; then
            printf 'echo -debug %%arg{1} ; '
            printf 'echo -quoting shell -debug %%val{selections} ; '
            printf 'fail "Check failed" ; '
        fi
    }
}

define-command do-operation-and-check -params 2 %{
    set-operation %arg{1}
    assert-selections-are %arg{2}
}

edit -scratch *set-operations-test-1*

# basic tests
exec '%diab<esc>'

## union
exec -save-regs '' 'ggZl'
do-operation-and-check union "'a' 'b'"

exec -save-regs '' 'gglZh'
do-operation-and-check union "'a' 'b'"

exec -save-regs '' 'ggLZ'
do-operation-and-check union "'ab'"

## intersection 
exec -save-regs '' 'ggLZ'
do-operation-and-check intersection "'ab'"

exec -save-regs '' 'ggZL'
do-operation-and-check intersection "'a'"

exec -save-regs '' 'ggLZgg'
do-operation-and-check intersection "'a'"

exec -save-regs '' 'gglZhL'
do-operation-and-check intersection "'b'"

exec -save-regs '' 'ggLZhl'
do-operation-and-check intersection "'b'"

## difference
exec -save-regs '' 'ggLZ'
assert-command-fails %{ set-operation difference }

exec -save-regs '' 'ggZL'
do-operation-and-check difference "'b'"

exec -save-regs '' 'gglZhL'
do-operation-and-check difference "'a'"

exec '%diabcd<esc>'
exec -save-regs '' 'gglLZglhL'
do-operation-and-check difference "'d'"

exec -save-regs '' 'glZggLs.<ret>'
do-operation-and-check difference "'a' 'b'"

delete-buffer
