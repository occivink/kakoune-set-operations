try %{
    require-module set-operations
} catch %{
    source set-operations.kak
    require-module set-operations
}

define-command assert-command-fails -params 1 %{
    eval -save-regs e %{
        reg e ''
        try %{
            eval %arg{1}
            reg e 'print-stack-trace'
        }
        eval %reg{e}
    }
}

define-command assert-selections-are -params 1 %{
    eval %sh{
        if [ "$1" != "$kak_quoted_selections" ]; then
            printf 'print-stack-trace ; '
        fi
    }
}

define-command do-operation-and-check -params 2 %{
    eval -draft %{
        set-operation %arg{1}
        assert-selections-are %arg{2}
    }
}

define-command set-buffer -params 1 %{
    eval -save-regs t %{
        reg dquote %arg{1}

        exec '%R'
        exec -draft '%s[()]<ret>d'
        exec '%1s\{(.+?)\}<ret>'
        exec -draft '<a-;>hd'
        exec -draft 'ld'
        reg t %val{selections_desc}

        exec '%R'
        exec -draft '%s[{}]<ret>d'
        exec '%1s\((.+?)\)<ret>'
        exec -draft '<a-;>hd'
        exec -draft 'ld'

        reg caret "%val{buffile}@%val{timestamp}@0" %reg{t}
    }

}

edit -scratch *set-operations-test-1*

# basic tests
set-buffer '(a)b{c}'
do-operation-and-check union "'a' 'c'"
assert-command-fails %{ set-operation intersection }
do-operation-and-check difference "'a'"

set-buffer '(ab{c})'
do-operation-and-check union "'abc'"
do-operation-and-check intersection "'c'"
do-operation-and-check difference "'ab'"

set-buffer '{(a)b}c'
do-operation-and-check union "'ab'"
do-operation-and-check intersection "'a'"
assert-command-fails %{ set-operation difference }

set-buffer '(a{b}c)'
do-operation-and-check union "'abc'"
do-operation-and-check intersection "'b'"
do-operation-and-check difference "'a' 'c'"

set-buffer '{(a)(b)(c)}'
#do-operation-and-check union "'abc'" TODO check
do-operation-and-check intersection "'a' 'b' 'c'"
assert-command-fails %{ set-operation difference }

set-buffer '{a(b}c)'
#do-operation-and-check union "'abc'" TODO check
do-operation-and-check intersection "'b'"
do-operation-and-check difference "'c'"

set-buffer '({a}{b}{c})'
do-operation-and-check union "'abc'"
do-operation-and-check intersection "'a' 'b' 'c'"
assert-command-fails %{ set-operation difference }

set-buffer '(foo bar)
{abc def}'
do-operation-and-check union "'foo bar' 'abc def'"
assert-command-fails %{ set-operation intersection }
do-operation-and-check difference "'foo bar'"

set-buffer '(foo) {bar}
(abc) {def}'
do-operation-and-check union "'foo' 'bar' 'abc' 'def'"
assert-command-fails %{ set-operation intersection }
do-operation-and-check difference "'foo' 'abc'"


set-buffer '{(foo) (bar)
(abc) (def)}'
#do-operation-and-check union "'foo bar
#abc def'" TODO check
do-operation-and-check intersection "'foo' 'bar' 'abc' 'def'"
assert-command-fails %{ set-operation difference }

set-buffer 'f{oo (ba}r ){ab}c (def)'
do-operation-and-check union "'oo bar ' 'ab' 'def'"
do-operation-and-check intersection "'ba'"
do-operation-and-check difference "'r ' 'def'"

set-buffer '{f(oo)( b)a}(r {b)(a}z) {abc} (de{f) g}hi'
#do-operation-and-check union "'foo ba' 'r baz' 'abc' 'def g'" TODO check
do-operation-and-check intersection "'oo' ' b' 'b' 'a' 'f'"
do-operation-and-check difference "'r ' 'z' 'de'"

delete-buffer
